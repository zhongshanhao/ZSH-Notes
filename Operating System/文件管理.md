操作系统文件管理需要解决的问题

- 计算机中存放了各种各样的文件，一个文件有哪些属性？

> 文件名、标识符、类型、位置、大小、创建时间、上次修改时间、文件所有者、保护信息
>
> 标识符：一个系统内的各文件标识符唯一，是操作系统用于区分各个文件的一种内部名称

- 文件内部的数据应该怎么组织起来（文件的逻辑结构）？

> 无结构文件（流式文件）：如文本文件
>
> 有结构文件（记录式文件）：如数据库表
>
> 有结构文件中，各个记录应该如何组织？
>
> 应该顺序存放？还是用索引表来记录间的顺序？--这是“文件的逻辑结构”重点要探讨的问题

- 文件之间又应该怎么组织起来（目录结构）

> 用户可以自己创建一层一层的目录，各层目录中存放相应的文件。系统中的各个文件就通过一层一层的目录合理有序的组织起来了
>
> 目录其实也是一种特殊的有结构文件（由记录组成），如何实现文件目录是之后会重点探讨的问题

- 操作系统应向上提供哪些功能？（create、delete、open、close、read、write系统调用）
- 文件应如何存放在外存中（文件的物理结构）
- 操作系统如何管理外存中的空闲块（存储空间的管理）
- 操作系统需要提供的其他文件管理功能：文件共享，文件保护

## Linux文件系统

Linux文件系统把多个扇区组成了一个逻辑块，每次读写的最小单位就是逻辑块（数据块），Linux中的逻辑块大小为4KB，文件离散地存储在磁盘上，通过索引节点记录所有文件数据块存放的数据块。

Linux文件系统会为每个文件分配两个数据结构：索引节点和目录项

- 索引节点，也就是inode，用来记录文件的元信息，比如inode编号、文件大小、访问权限、创建时间、修改时间、**数据在磁盘中的位置**等，索引节点是文件的唯一标识，存放在磁盘上
- 目录项，也就是dentry，用来记录文件的名字，索引节点指针以及父目录、子目录，目录项是由内核维护的一个数据结构，不存放于磁盘，而是缓存在内存中。

<img src="C:\Users\zsh\AppData\Roaming\Typora\typora-user-images\image-20210812205013184.png" alt="image-20210812205013184" style="zoom:67%;" />

文件存储方式

索引数据块

索引的实现就是为每个文件创建一个索引数据块，里边存放的是指向文件数据块的指针列表，文件头需要包含指向索引数据块的指针，这样就可以通过文件头知道索引数据块的位置，再通过索引数据块里的索引信息找到对应的数据块。

unix文件实现存储的方式

为了适配小文件和大文件存储，文件头inode包含13个指针

- 10个直接指向数据块的指针
- 一个指向索引块的指针
- 一个指向二级索引块的指针
- 一个指向三级索引块的指针

<img src="C:\Users\zsh\AppData\Roaming\Typora\typora-user-images\image-20210812205414099.png" alt="image-20210812205414099" style="zoom:67%;" />

<img src="C:\Users\zsh\AppData\Roaming\Typora\typora-user-images\image-20210812205436651.png" alt="image-20210812205436651" style="zoom:67%;" />

目录的存储

和普通文件不同，普通文件的块里面保存的是文件数据，而目录文件的块里边保存的是目录里边的一项一项的文件信息。

通常，第一项`.`表示当前目录，第二项`..`表示上一级目录，对当前目录下的文件，用哈希表存储，以加快查找效率，key是文件名的哈希值，value是文件项存储的块号。

![image-20210812210604643](C:\Users\zsh\AppData\Roaming\Typora\typora-user-images\image-20210812210604643.png)

## 设计一个简单的文件系统

### 文件系统结构

将磁盘分成块（block），假设块大小是4KB，就是说该文件系统读写的基本单位是块。

假设我们磁盘有64个块，可以将

- 编号8-63的块分给数据块，数据块是用来真正存储用户数据的地方
- 编号3-7的块分给inodes，每个文件占用一个inode，inode用来存储文件的元数据信息，如该文件包含哪些数据块、文件的大小、所有者和访问权限等，假设一个inode占用256字节，那么要给块就可以存放16个indoe，表示16个文件
- 编号1和2分别用来做inodes和数据块的空闲列表，使用位图来表示块的空闲状态
- 编号为0的块用来给超级块，超级块包含该文件的特定信息，如文件系统中有多少个inode和数据块等，在挂载文件系统时，操作系统将首先读取超级块，初始化各种参数

![image-20210815154509770](C:\Users\zsh\AppData\Roaming\Typora\typora-user-images\image-20210815154509770.png)

inode表特写

![image-20210815155613142](C:\Users\zsh\AppData\Roaming\Typora\typora-user-images\image-20210815155613142.png)

大文件/多级索引存储

为了适配小文件和大文件存储，文件头inode包含13个指针

- 10个直接指向数据块的指针
- 一个指向索引块的指针（索引块就是数据块中存储的是指向其他数据块的指针）
- 一个指向二级索引块的指针
- 一个指向三级索引块的指针

目录组织

目录是一个特殊的文件，目录存放的是父目录和子目录中的文件或目录

假设目录dir（inode号是5）中有三个文件（foo、bar和foobar），它们的inode号分别为12、13和24，那么dir目录对应的数据块内容是：

![image-20210815160059459](C:\Users\zsh\AppData\Roaming\Typora\typora-user-images\image-20210815160059459.png)

当然，操作系统需要知道根目录`/`在哪，文件系统应该和操作系统达成一个共识：根目录存放的位置。

### 从磁盘中读取文件

假设文件系统已经挂载，超级块已经在内存中，其他所有内容仍在磁盘上，如何读取指定目录下的文件？

假设我们发出`open("/foo/bar", O_RDONLY)`调用时，找到该文件的步骤如下

- 从文件系统根目录开始遍历，在大多数UNIX文件系统中，根的inode号为2，因此我们一开始读入inode号2的块，然后得到对应的数据块，将数据块读入内存，遍历目录，得到目录`foo`对应的inode号，假设是44
- 将44号inode读入内存，得到对应的数据块指针，将数据块读入内存， 找到文件`bar`对应的inode号，假设是33
- 将33号inode读入内存，在每个进程的打开文件表中，为此进程分配一个文件描述符，将它返回给用户

打开文件后，程序可以发出`read()`系统调用，读取将会根据inode中数据块指针找到对应的数据块。读取还会更新inode块中的访问时间，还有偏移量，以便下次读取下一个文件块

文件读取时间线

<img src="C:\Users\zsh\AppData\Roaming\Typora\typora-user-images\image-20210815191401090.png" alt="image-20210815191401090" style="zoom:80%;" />

### 写入文件

创建一个文件`/foo/bar`，并向它写入3个块

- 从根节点遍历，找到`foo`文件夹
- 读取`inode`的`bitmap`，为`bar`文件分配一个空闲的`inode`号，将元数据存入对应的`inode`号，同时需要更新父目录`foo`，将`bar`信息加入到父目录中
- 读取`data`的`bitmap`，找到空闲的数据块，更新`bitmap`，到对应数据块写入数据，然后更新`inode`，将数据块信息写入`inode`

<img src="C:\Users\zsh\AppData\Roaming\Typora\typora-user-images\image-20210815192927846.png" alt="image-20210815192927846" style="zoom:80%;" />

### 性能优化

将磁盘分区，`inode`和其对应的数据块放在同一个分区中，这样，避免长距离移动机械臂导致性能下降。